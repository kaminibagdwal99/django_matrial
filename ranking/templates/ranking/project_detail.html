{% extends "layouts/base.html" %}
{% load static %}

{% block content %}
<!-- Include Material Symbols -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />

<div class="container-fluid py-4">

  <a href="{% url 'ranking:project_report' project.id %}" class="btn btn-outline-primary btn-sm float-end">
    <span class="material-symbols-rounded align-middle">assessment</span> View Report
  </a>


  <!-- Title -->
  <div class="row mb-4">
    <div class="col-12">
      <h4 class="fw-bold text-dark">Project Dashboard: {{ project.name }}</h4>
      <p class="text-sm text-muted mb-0">Domain: {{ project.url }} | Created: {{ project.created_at }}</p>
    </div>
  </div>

  

  <!-- Metric Cards -->
  <div class="row">
    {% for metric in metrics %}
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body d-flex flex-column justify-content-between h-100">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="text-sm text-muted mb-1">{{ metric.label }}</p>
              <h5 class="fw-bold mb-0">{{ metric.value }}</h5>
            </div>
            <div class="bg-gradient-primary text-white d-flex align-items-center justify-content-center rounded-circle shadow"
                 style="width: 42px; height: 42px;">
              <span class="material-symbols-rounded">{{ metric.icon }}</span>
            </div>
          </div>
          {% if metric.change is not None %}
          <div class="mt-3">
            <p class="mb-0 text-sm">
              <span class="text-{{ metric.change_type }} fw-bold">{{ metric.change }}</span>
              compared to last period
            </p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Charts -->
  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header pb-0">
          <h6 class="mb-0">Keyword Trends</h6>
        </div>
        <div class="card-body pt-3">
          <canvas id="keywordTrendChart" height="150"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header pb-0">
          <h6 class="mb-0">Organic Traffic Trends</h6>
        </div>
        <div class="card-body pt-3">
          <canvas id="trafficTrendChart" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Keywords & Search Engines -->
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header pb-0">
          <h6 class="mb-0">Keywords</h6>
        </div>
        <div class="card-body pt-3">
          <ul class="list-group">
            {% for keyword in keywords %}
              <li class="list-group-item">{{ keyword.keyword }}</li>
            {% empty %}
              <li class="list-group-item">No keywords added yet.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header pb-0">
          <h6 class="mb-0">Search Engines</h6>
        </div>
        <div class="card-body pt-3">
          <ul class="list-group">
            {% for engine in search_engines %}
              <li class="list-group-item">
                {{ engine.name }} ({{ engine.country }}/{{ engine.language }})
              </li>
            {% empty %}
              <li class="list-group-item">No search engines configured.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid py-4">
  <div class="card">
    <div class="card-header pb-0">
      <h5 class="mb-0">Upload Keyword Rankings</h5>
    </div>
    <div class="card-body">
      <form action="{% url 'ranking:upload_rankings' project.id %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
          <label for="rankingFile" class="form-label">Choose a CSV or Excel file</label>
          <input type="file" name="ranking_file" id="rankingFile" class="form-control" accept=".csv, .xlsx" required>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-upload me-2"></i>Upload Rankings
        </button>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const chartLabels = {{ chart_data.labels|safe }};
  const keywordData = {{ chart_data.keyword_trend|safe }};
  const trafficData = {{ chart_data.traffic_trend|safe }};

  new Chart(document.getElementById("keywordTrendChart"), {
    type: 'line',
    data: {
      labels: chartLabels,
      datasets: [{
        label: 'Keywords',
        data: keywordData,
        borderColor: '#5e72e4',
        backgroundColor: 'rgba(94, 114, 228, 0.2)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  new Chart(document.getElementById("trafficTrendChart"), {
    type: 'line',
    data: {
      labels: chartLabels,
      datasets: [{
        label: 'Organic Traffic',
        data: trafficData,
        borderColor: '#2dce89',
        backgroundColor: 'rgba(45, 206, 137, 0.2)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
</script>
{% endblock %}
